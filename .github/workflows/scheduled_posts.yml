name: Scheduled Blog Posts to Twitter

on:
  schedule:
    # 日本時間（JST）で8時、14時、20時に実行
    # UTC時間で計算: JST = UTC + 9時間
    # 8時JST = 23時UTC（前日）
    # 14時JST = 5時UTC
    # 20時JST = 11時UTC
    # 注: ランダム性は投稿選択時に実現されています
    - cron: '0 23 * * *'  # 8時JST（23時UTC）
    - cron: '0 5 * * *'   # 14時JST（5時UTC）
    - cron: '0 11 * * *'  # 20時JST（11時UTC）
  workflow_dispatch:  # 手動実行も可能

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_365BOT_API_KEY: ${{ secrets.TWITTER_365BOT_API_KEY }}
        TWITTER_365BOT_API_SECRET: ${{ secrets.TWITTER_365BOT_API_SECRET }}
        TWITTER_365BOT_ACCESS_TOKEN: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN }}
        TWITTER_365BOT_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN_SECRET }}
        TWITTER_PURSAHS_API_KEY: ${{ secrets.TWITTER_PURSAHS_API_KEY }}
        TWITTER_PURSAHS_API_SECRET: ${{ secrets.TWITTER_PURSAHS_API_SECRET }}
        TWITTER_PURSAHS_ACCESS_TOKEN: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN }}
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN_SECRET }}
      run: |
        cat > .env << EOF
        TWITTER_API_KEY=$TWITTER_API_KEY
        TWITTER_API_SECRET=$TWITTER_API_SECRET
        TWITTER_ACCESS_TOKEN=$TWITTER_ACCESS_TOKEN
        TWITTER_ACCESS_TOKEN_SECRET=$TWITTER_ACCESS_TOKEN_SECRET
        TWITTER_BEARER_TOKEN=$TWITTER_BEARER_TOKEN
        TWITTER_365BOT_API_KEY=$TWITTER_365BOT_API_KEY
        TWITTER_365BOT_API_SECRET=$TWITTER_365BOT_API_SECRET
        TWITTER_365BOT_ACCESS_TOKEN=$TWITTER_365BOT_ACCESS_TOKEN
        TWITTER_365BOT_ACCESS_TOKEN_SECRET=$TWITTER_365BOT_ACCESS_TOKEN_SECRET
        TWITTER_PURSAHS_API_KEY=$TWITTER_PURSAHS_API_KEY
        TWITTER_PURSAHS_API_SECRET=$TWITTER_PURSAHS_API_SECRET
        TWITTER_PURSAHS_ACCESS_TOKEN=$TWITTER_PURSAHS_ACCESS_TOKEN
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET=$TWITTER_PURSAHS_ACCESS_TOKEN_SECRET
        BLOG_365BOT_URL=http://notesofacim.blog.fc2.com/
        TWITTER_365BOT_HANDLE=365botGary
        BLOG_PURSAHS_URL=https://www.ameba.jp/profile/general/pursahs-gospel/
        TWITTER_PURSAHS_HANDLE=pursahsgospel
        POST_INTERVAL_HOURS=24
        MAX_POST_LENGTH=280
        EOF
    
    - name: Download database from previous run
      uses: actions/cache@v3
      id: cache-db
      with:
        path: posts.db
        key: posts-db-v1
        restore-keys: |
          posts-db-
    
    - name: Run scheduled post
      run: |
        python main.py
    
    - name: Upload database for next run
      if: always()
      uses: actions/cache@v3
      with:
        path: posts.db
        key: posts-db-v1
