name: Scheduled Blog Posts to Twitter

on:
  schedule:
    # 日本時間（JST）で8時、14時、20時に実行
    # UTC時間で計算: JST = UTC + 9時間
    # 8時JST = 23時UTC（前日）
    # 14時JST = 5時UTC
    # 20時JST = 11時UTC
    # 注: ランダム性は投稿選択時に実現されています
    - cron: '0 23 * * *'  # 8時JST（23時UTC）
    - cron: '0 5 * * *'   # 14時JST（5時UTC）
    - cron: '0 11 * * *'  # 20時JST（11時UTC）
  workflow_dispatch:  # 手動実行も可能

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_365BOT_API_KEY: ${{ secrets.TWITTER_365BOT_API_KEY }}
        TWITTER_365BOT_API_SECRET: ${{ secrets.TWITTER_365BOT_API_SECRET }}
        TWITTER_365BOT_ACCESS_TOKEN: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN }}
        TWITTER_365BOT_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN_SECRET }}
        TWITTER_PURSAHS_API_KEY: ${{ secrets.TWITTER_PURSAHS_API_KEY }}
        TWITTER_PURSAHS_API_SECRET: ${{ secrets.TWITTER_PURSAHS_API_SECRET }}
        TWITTER_PURSAHS_ACCESS_TOKEN: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN }}
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN_SECRET }}
      run: |
        cat > .env << EOF
        TWITTER_API_KEY=$TWITTER_API_KEY
        TWITTER_API_SECRET=$TWITTER_API_SECRET
        TWITTER_ACCESS_TOKEN=$TWITTER_ACCESS_TOKEN
        TWITTER_ACCESS_TOKEN_SECRET=$TWITTER_ACCESS_TOKEN_SECRET
        TWITTER_BEARER_TOKEN=$TWITTER_BEARER_TOKEN
        TWITTER_365BOT_API_KEY=$TWITTER_365BOT_API_KEY
        TWITTER_365BOT_API_SECRET=$TWITTER_365BOT_API_SECRET
        TWITTER_365BOT_ACCESS_TOKEN=$TWITTER_365BOT_ACCESS_TOKEN
        TWITTER_365BOT_ACCESS_TOKEN_SECRET=$TWITTER_365BOT_ACCESS_TOKEN_SECRET
        TWITTER_PURSAHS_API_KEY=$TWITTER_PURSAHS_API_KEY
        TWITTER_PURSAHS_API_SECRET=$TWITTER_PURSAHS_API_SECRET
        TWITTER_PURSAHS_ACCESS_TOKEN=$TWITTER_PURSAHS_ACCESS_TOKEN
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET=$TWITTER_PURSAHS_ACCESS_TOKEN_SECRET
        BLOG_365BOT_URL=http://notesofacim.blog.fc2.com/
        TWITTER_365BOT_HANDLE=365botGary
        BLOG_PURSAHS_URL=https://www.ameba.jp/profile/general/pursahs-gospel/
        TWITTER_PURSAHS_HANDLE=pursahsgospel
        POST_INTERVAL_HOURS=24
        MAX_POST_LENGTH=280
        EOF
    
    - name: Run test post output (dry-run)
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from blog_fetcher import BlogFetcher
        from twitter_poster import TwitterPoster
        from config import Config
        
        # 365botGary用のテスト
        print('=== 365botGary テスト ===')
        page_url = 'http://notesofacim.blog.fc2.com/blog-entry-44.html'
        fetcher = BlogFetcher(page_url)
        post_data = fetcher.fetch_latest_post()
        
        if post_data:
            credentials = Config.get_twitter_credentials_365bot()
            poster = TwitterPoster(credentials)
            tweet_text = poster.format_blog_post(
                title=post_data.get('title', ''),
                content=post_data.get('content', ''),
                link=post_data.get('link', page_url)
            )
            print(f'タイトル: {post_data.get(\"title\", \"\")}')
            print(f'リンク: {post_data.get(\"link\", \"\")}')
            print(f'投稿予定のツイートテキスト:')
            print(tweet_text)
            print(f'文字数: {len(tweet_text)} 文字（リンク含む: {len(tweet_text) + 24} 文字）')
        
        # pursahsgospel用のテスト
        print('\n\n=== pursahsgospel テスト ===')
        page_url = 'https://ameblo.jp/pursahs-gospel/entry-11577213279.html'
        fetcher = BlogFetcher(page_url)
        post_data = fetcher.fetch_latest_post()
        
        if post_data:
            credentials = Config.get_twitter_credentials_pursahs()
            poster = TwitterPoster(credentials)
            tweet_text = poster.format_blog_post(
                title=post_data.get('title', ''),
                content=post_data.get('content', ''),
                link=post_data.get('link', page_url)
            )
            print(f'タイトル: {post_data.get(\"title\", \"\")}')
            print(f'リンク: {post_data.get(\"link\", \"\")}')
            print(f'投稿予定のツイートテキスト:')
            print(tweet_text)
            print(f'文字数: {len(tweet_text)} 文字（リンク含む: {len(tweet_text) + 24} 文字）')
        "
    
    - name: Run scheduled post (single page)
      run: |
        python post_single_page.py
