name: Scheduled Blog Posts to Twitter

on:
  schedule:
    # 日本時間（JST）で8時、14時、20時に実行
    # UTC時間で計算: JST = UTC + 9時間
    # 8時JST = 23時UTC（前日）
    # 14時JST = 5時UTC
    # 20時JST = 11時UTC
    # 注: ランダム性は投稿選択時に実現されています
    - cron: '0 23 * * *'  # 8時JST（23時UTC）
    - cron: '0 5 * * *'   # 14時JST（5時UTC）
    - cron: '0 11 * * *'  # 20時JST（11時UTC）
  workflow_dispatch:  # 手動実行も可能

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_365BOT_API_KEY: ${{ secrets.TWITTER_365BOT_API_KEY }}
        TWITTER_365BOT_API_SECRET: ${{ secrets.TWITTER_365BOT_API_SECRET }}
        TWITTER_365BOT_ACCESS_TOKEN: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN }}
        TWITTER_365BOT_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_365BOT_ACCESS_TOKEN_SECRET }}
        TWITTER_PURSAHS_API_KEY: ${{ secrets.TWITTER_PURSAHS_API_KEY }}
        TWITTER_PURSAHS_API_SECRET: ${{ secrets.TWITTER_PURSAHS_API_SECRET }}
        TWITTER_PURSAHS_ACCESS_TOKEN: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN }}
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_PURSAHS_ACCESS_TOKEN_SECRET }}
      run: |
        cat > .env << EOF
        TWITTER_API_KEY=$TWITTER_API_KEY
        TWITTER_API_SECRET=$TWITTER_API_SECRET
        TWITTER_ACCESS_TOKEN=$TWITTER_ACCESS_TOKEN
        TWITTER_ACCESS_TOKEN_SECRET=$TWITTER_ACCESS_TOKEN_SECRET
        TWITTER_BEARER_TOKEN=$TWITTER_BEARER_TOKEN
        TWITTER_365BOT_API_KEY=$TWITTER_365BOT_API_KEY
        TWITTER_365BOT_API_SECRET=$TWITTER_365BOT_API_SECRET
        TWITTER_365BOT_ACCESS_TOKEN=$TWITTER_365BOT_ACCESS_TOKEN
        TWITTER_365BOT_ACCESS_TOKEN_SECRET=$TWITTER_365BOT_ACCESS_TOKEN_SECRET
        TWITTER_PURSAHS_API_KEY=$TWITTER_PURSAHS_API_KEY
        TWITTER_PURSAHS_API_SECRET=$TWITTER_PURSAHS_API_SECRET
        TWITTER_PURSAHS_ACCESS_TOKEN=$TWITTER_PURSAHS_ACCESS_TOKEN
        TWITTER_PURSAHS_ACCESS_TOKEN_SECRET=$TWITTER_PURSAHS_ACCESS_TOKEN_SECRET
        BLOG_365BOT_URL=http://notesofacim.blog.fc2.com/
        TWITTER_365BOT_HANDLE=365botGary
        BLOG_PURSAHS_URL=https://www.ameba.jp/profile/general/pursahs-gospel/
        TWITTER_PURSAHS_HANDLE=pursahsgospel
        POST_INTERVAL_HOURS=24
        MAX_POST_LENGTH=280
        EOF
    
    - name: Initialize posts database from index pages
      run: |
        python init_posts_from_index.py
    
    - name: Run test post output (dry-run)
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from blog_fetcher import BlogFetcher
        from twitter_poster import TwitterPoster
        from config import Config
        
        from database import PostDatabase
        
        # 365botGary用のテスト
        print('=== 365botGary テスト ===')
        db = PostDatabase()
        blog_url = Config.BLOG_365BOT_URL
        twitter_handle = Config.TWITTER_365BOT_HANDLE
        
        all_posts = db.get_all_posts(blog_url)
        print(f'データベース内のURL数: {len(all_posts)} 件')
        
        if all_posts:
            post_data = db.get_random_unposted_post(blog_url, twitter_handle)
            if post_data:
                page_url = post_data.get('link', '')
                print(f'選択されたURL: {page_url}')
                
                # ページからコンテンツを取得
                fetcher = BlogFetcher(page_url)
                page_content = fetcher.fetch_latest_post()
                
                if page_content:
                    credentials = Config.get_twitter_credentials_365bot()
                    poster = TwitterPoster(credentials)
                    tweet_text = poster.format_blog_post(
                        title=page_content.get('title', ''),
                        content=page_content.get('content', ''),
                        link=page_content.get('link', page_url)
                    )
                    print(f'タイトル: {page_content.get(\"title\", \"\")}')
                    print(f'リンク: {page_content.get(\"link\", \"\")}')
                    print(f'投稿予定のツイートテキスト:')
                    print(tweet_text)
                    print(f'文字数: {len(tweet_text)} 文字（リンク含む: {len(tweet_text) + 24} 文字）')
        
        # pursahsgospel用のテスト
        print('\n\n=== pursahsgospel テスト ===')
        blog_url = Config.BLOG_PURSAHS_URL
        twitter_handle = Config.TWITTER_PURSAHS_HANDLE
        
        all_posts = db.get_all_posts(blog_url)
        print(f'データベース内のURL数: {len(all_posts)} 件')
        
        if all_posts:
            post_data = db.get_random_unposted_post(blog_url, twitter_handle)
            if post_data:
                page_url = post_data.get('link', '')
                print(f'選択されたURL: {page_url}')
                
                # ページからコンテンツを取得
                fetcher = BlogFetcher(page_url)
                page_content = fetcher.fetch_latest_post()
                
                if page_content:
                    credentials = Config.get_twitter_credentials_pursahs()
                    poster = TwitterPoster(credentials)
                    tweet_text = poster.format_blog_post(
                        title=page_content.get('title', ''),
                        content=page_content.get('content', ''),
                        link=page_content.get('link', page_url)
                    )
                    print(f'タイトル: {page_content.get(\"title\", \"\")}')
                    print(f'リンク: {page_content.get(\"link\", \"\")}')
                    print(f'投稿予定のツイートテキスト:')
                    print(tweet_text)
                    print(f'文字数: {len(tweet_text)} 文字（リンク含む: {len(tweet_text) + 24} 文字）')
        "
    
    - name: Run scheduled post
      run: |
        python main.py
