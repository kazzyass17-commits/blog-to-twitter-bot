# 403エラーの対策

## 現在の状況（2026年1月3日）

### pursahsgospelアカウントの診断結果

✅ **読み取り権限**: 正常（ユーザーID: 2416625168）
⚠️ **投稿テスト**: レート制限（429エラー）により中断

**結論**: 
- 403エラーではなく、レート制限が原因です
- 権限自体に問題はありません
- レート制限が解除されれば投稿可能です

## 403エラーの主な原因と対策

### 1. アプリの権限設定

**症状**: 403 Forbiddenエラーが発生

**確認方法**:
1. X Developer Portalにアクセス
2. アプリの「Settings」タブを開く
3. 「App permissions」セクションを確認
4. 「Read and write」が選択されているか確認

**対策**:
- 「Read and write」を選択して「Save」
- 権限変更後、必ずAccess Tokenを再生成
- 再生成したAccess Tokenを`.env`ファイルに反映

### 2. Access Tokenの再生成が必要

**症状**: 権限を変更したが、まだ403エラーが発生

**原因**: 権限変更前のAccess Tokenを使用している

**対策**:
1. X Developer Portalの「Keys and tokens」タブを開く
2. 「Access Token and Secret」セクションで「Regenerate」をクリック
3. 新しいAccess TokenとAccess Token Secretをコピー
4. `.env`ファイルを更新

### 3. アプリの状態に問題がある

**症状**: 403エラーが続く

**確認方法**:
1. X Developer Portalの「Overview」タブを確認
2. アプリの状態を確認：
   - 「Active」: 正常
   - 「Pending approval」: 承認待ち
   - 「SUSPENDED」: 停止中

**対策**:
- 「Pending approval」の場合: X側の承認を待つ
- 「SUSPENDED」の場合: X Developer Portalのサポートに問い合わせ

### 4. テキストの長さや内容による制限

**症状**: 短いテキストは成功、長いテキストで403エラー

**原因**: 
- テキストの長さによる制限
- テキストの内容によるフィルタリング
- URLを含む長いテキストの制限

**対策**:
- テキストの長さを調整（280文字以内）
- テキストの内容を確認
- URLを含む場合は、URLを23文字として計算

### 5. IPアドレスがブロックされている

**症状**: ローカル環境では成功、GitHub Actionsでは403エラー

**原因**: GitHub ActionsのIPアドレスがブロックされている

**対策**:
- ローカルPCでの運用を継続
- 時間を置いてから再試行（1時間〜数時間）
- 別の時間帯に再試行

### 6. レート制限（429エラー）との混同

**症状**: 403エラーと表示されるが、実際はレート制限

**確認方法**:
- エラーメッセージを確認
- 429 Too Many Requestsの場合はレート制限
- 403 Forbiddenの場合は権限の問題

**対策**:
- レート制限の場合は、リセット時刻まで待機
- 403エラーの場合は、上記の対策を実施

## 診断スクリプトの使用方法

### 基本的な使用方法

```bash
# pursahsgospelアカウントのみ診断
python diagnose_403_error.py --account pursahs

# 365botGaryアカウントのみ診断
python diagnose_403_error.py --account 365bot

# 両方のアカウントを診断
python diagnose_403_error.py --account both
```

### 診断内容

1. **アカウント情報の取得（読み取りテスト）**
   - アカウント情報が取得できるか確認
   - 読み取り権限があるか確認

2. **短いテキストでの投稿テスト（50文字）**
   - 基本的な投稿権限があるか確認

3. **中程度のテキストでの投稿テスト（150文字）**
   - 中程度の長さのテキストで投稿できるか確認

4. **長いテキストでの投稿テスト（250文字）**
   - 長いテキストで投稿できるか確認

5. **URL付きテキストでの投稿テスト**
   - URLを含む投稿ができるか確認

## 次のステップ

### 1. レート制限が解除されるまで待機

現在、pursahsgospelアカウントはレート制限中です。
- レート制限のリセット時刻を確認
- リセット時刻まで待機
- その後、再度投稿テストを実行

### 2. 403エラーが発生した場合

1. `diagnose_403_error.py`を実行して原因を特定
2. 上記の対策を実施
3. 再度診断スクリプトを実行して確認

### 3. 継続的に403エラーが発生する場合

1. X Developer Portalでアプリの状態を確認
2. Access Tokenを再生成
3. `.env`ファイルを更新
4. 時間を置いてから再試行

## まとめ

**現在の状況**:
- ✅ pursahsgospelアカウントの権限は正常
- ⚠️ レート制限中（403エラーではない）

**推奨される対処法**:
1. レート制限が解除されるまで待機
2. レート制限解除後、再度投稿テストを実行
3. 403エラーが発生した場合は、`diagnose_403_error.py`で診断








