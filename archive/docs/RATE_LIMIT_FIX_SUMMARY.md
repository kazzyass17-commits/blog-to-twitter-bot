# 429エラー対策 - 待機時間チェック機能の追加

## 実施した対策

### 1. 共通の待機時間チェックモジュールを作成

**ファイル**: `rate_limit_checker.py`
- `load_rate_limit_state()`: 待機時間の状態を読み込む
- `save_rate_limit_state()`: 待機時間の状態を保存する
- `check_and_wait_for_account()`: アカウントの待機時間をチェックし、必要に応じて待機する

### 2. 各スクリプトに待機時間チェック機能を追加

#### ✅ `test_post.py`
- 投稿前に待機時間をチェック
- 待機中の場合は、待機時間が終了するまで待機してから投稿

#### ✅ `main_365bot.py`
- 投稿前に待機時間をチェック
- 待機中の場合は、処理をスキップ

#### ✅ `main_pursahs.py`
- 投稿前に待機時間をチェック
- 待機中の場合は、処理をスキップ

### 3. 既に実装済みのスクリプト

#### ✅ `test_post_with_rate_limit_management.py`
- 待機時間チェック機能が既に実装済み

## 待機時間チェック機能の動作

1. **待機時間の確認**
   - `rate_limit_state.json`から待機時間を読み込む
   - 待機時間が設定されている場合、現在時刻と比較

2. **待機中の処理**
   - 待機時間が残っている場合、待機時間が終了するまで待機
   - 待機中は定期的に残り時間を表示

3. **待機時間のクリア**
   - 待機時間が終了したら、`rate_limit_state.json`から待機時間をクリア
   - リセット時刻まで待機（10秒の余裕を持たせる）

## 429エラーの原因と対策

### 原因
- `test_post.py`が待機時間をチェックせずにAPIを呼び出していた
- `main_365bot.py`と`main_pursahs.py`が待機時間をチェックせずにAPIを呼び出していた

### 対策
- すべての投稿スクリプトに待機時間チェック機能を追加
- 待機時間中の場合は、待機時間が終了するまで待機してから投稿

## 今後の注意事項

1. **新しいスクリプトを作成する場合**
   - `rate_limit_checker.py`をインポート
   - 投稿前に`check_and_wait_for_account()`を呼び出す

2. **待機時間の確認**
   - `check_rate_limit_state.py`で待機時間を確認できる

3. **レート制限が発生した場合**
   - `twitter_poster.py`で429エラーを検出
   - `rate_limit_state.json`に待機時間を保存
   - 次回実行時に待機時間をチェックして待機

## まとめ

- ✅ すべての投稿スクリプトに待機時間チェック機能を追加
- ✅ 429エラーが発生しないように対策を実施
- ✅ 待機時間を守ることで、レート制限に達することを防止










